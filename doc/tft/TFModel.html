<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                "http://www.w3.org/TR/REC-html40/loose.dtd">
<html>
<head>
  <title>Description of TFModel</title>
  <meta name="keywords" content="TFModel">
  <meta name="description" content="Represents data required to describe a tensor factorization model">
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
  <meta name="generator" content="m2html &copy; 2005 Guillaume Flandin">
  <meta name="robots" content="index, follow">
  <link type="text/css" rel="stylesheet" href="../m2html.css">
  <script type="text/javascript">
    if (top.frames.length == 0) { top.location = "../index.html"; };
  </script>
</head>
<body>
<a name="_top"></a>
<!-- menu.html tft -->
<h1>TFModel
</h1>

<h2><a name="_name"></a>PURPOSE <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="box"><strong>Represents data required to describe a tensor factorization model</strong></div>

<h2><a name="_synopsis"></a>SYNOPSIS <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="box"><strong>This is a script file. </strong></div>

<h2><a name="_description"></a>DESCRIPTION <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="fragment"><pre class="comment"> Represents data required to describe a tensor factorization model

   A model is represented with its name and factors array of
   TFFactor objects. dims array of TFDimension objects define
   dimensions used by this model. Dimensions are transfered to C++
   in the order defined in dims array. See examples below for a
   full model description.

   Examples:
   
   dim_i = TFDimension('name', 'i', 'cardinality', 5);
   dim_j = TFDimension('cardinality', 6, 'name', 'j');
   dim_k = TFDimension('cardinality', 7, 'name', 'k');
   dim_r = TFDimension('cardinality', 10, 'name', 'r');
   
   p_A=TFFactor('name', 'p_A', 'type', 'latent', 'dims', [dim_i dim_r]);
   p_B=TFFactor('name', 'p_B', 'type', 'latent', 'dims', [dim_j dim_r]);
   p_C=TFFactor('name', 'p_C', 'type', 'latent', 'dims', [dim_k dim_r]);
   
   parafac_model = TFModel('name', 'Parafac', 'factors', [p_A p_B p_C X], 'dims', [dim_i dim_j dim_k dim_r]);
   
   parafac_model.rand_init_latent_factors('all');

   See also <a href="TFDimension.html" class="code" title="">TFDimension</a>, <a href="TFFactor.html" class="code" title="">TFFactor</a></pre></div>

<!-- crossreference -->
<h2><a name="_cross"></a>CROSS-REFERENCE INFORMATION <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
This function calls:
<ul style="list-style-image:url(../matlabicon.gif)">
<li><a href="TFDimension.html" class="code" title="">TFDimension</a>	Represents a single dimension</li><li><a href="TFFactor.html" class="code" title="">TFFactor</a>	Represents a PLTF factor</li><li><a href="TFGraph.html" class="code" title="">TFGraph</a>	Represents a graph of TFModel objects.</li><li><a href="TFModel.html" class="code" title="">TFModel</a>	Represents data required to describe a tensor factorization model</li></ul>
This function is called by:
<ul style="list-style-image:url(../matlabicon.gif)">
<li><a href="TFGraph.html" class="code" title="">TFGraph</a>	Represents a graph of TFModel objects.</li><li><a href="TFModel.html" class="code" title="">TFModel</a>	Represents data required to describe a tensor factorization model</li></ul>
<!-- crossreference -->

<h2><a name="_subfunctions"></a>SUBFUNCTIONS <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<ul style="list-style-image:url(../matlabicon.gif)">
<li><a href="#_sub1" class="code">function obj = TFModel(varargin)</a></li><li><a href="#_sub2" class="code">function [] = pltf(obj, iternum)</a></li><li><a href="#_sub3" class="code">function [] = delta(obj, alpha, output_name, A)</a></li><li><a href="#_sub4" class="code">function [r] = eq(a,b)</a></li><li><a href="#_sub5" class="code">function [uncontraction_dims] = get_uncontraction_dims(obj)</a></li><li><a href="#_sub6" class="code">function [graph] = schedule_dp(obj)</a></li><li><a href="#_sub7" class="code">function [newmodel] = uncontract(obj, orig_model, dim)</a></li><li><a href="#_sub8" class="code">function [newmodel] = contract(obj, dim)</a></li><li><a href="#_sub9" class="code">function [obj] = update_cost_from_latent(obj)</a></li><li><a href="#_sub10" class="code">function [dn fn all_edges] = print_ubigraph(obj)</a></li><li><a href="#_sub11" class="code">function [size] = get_element_size(obj)</a></li><li><a href="#_sub12" class="code">function [card] = get_index_card(obj, index_char)</a></li><li><a href="#_sub13" class="code">function [factor] = get_first_non_observed_factor(obj)</a></li><li><a href="#_sub14" class="code">function [ind] = get_first_non_observed_factor_index(obj)</a></li><li><a href="#_sub15" class="code">function [ind] = find_cell_char(obj, chars)</a></li><li><a href="#_sub16" class="code">function [r] = get_dimension_index(obj, dim)</a></li><li><a href="#_sub17" class="code">function [ordered_index_chars] = order_dims(obj,</a></li><li><a href="#_sub18" class="code">function [newmodel] = contract_all(obj)</a></li><li><a href="#_sub19" class="code">function [contract_dims] = get_contraction_dims(obj)</a></li><li><a href="#_sub20" class="code">function [contract_dims] = get_current_contraction_dims(obj)</a></li><li><a href="#_sub21" class="code">function [factor_inds] = latent_factor_indices(obj)</a></li><li><a href="#_sub22" class="code">function [factors] = latent_factors(obj)</a></li><li><a href="#_sub23" class="code">function [factor_ind] = observed_factor_index(obj)</a></li><li><a href="#_sub24" class="code">function [factor] = observed_factor(obj)</a></li><li><a href="#_sub25" class="code">function [factors] = observed_factors(obj)</a></li><li><a href="#_sub26" class="code">function [factors] = input_factors(obj)</a></li><li><a href="#_sub27" class="code">function [factors] = temp_factors(obj)</a></li><li><a href="#_sub28" class="code">function [] = rand_init_latent_factors(obj, type, imax)</a></li></ul>

<h2><a name="_source"></a>SOURCE CODE <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="fragment"><pre>0001 <span class="comment">% Represents data required to describe a tensor factorization model</span>
0002 <span class="comment">%</span>
0003 <span class="comment">%   A model is represented with its name and factors array of</span>
0004 <span class="comment">%   TFFactor objects. dims array of TFDimension objects define</span>
0005 <span class="comment">%   dimensions used by this model. Dimensions are transfered to C++</span>
0006 <span class="comment">%   in the order defined in dims array. See examples below for a</span>
0007 <span class="comment">%   full model description.</span>
0008 <span class="comment">%</span>
0009 <span class="comment">%   Examples:</span>
0010 <span class="comment">%</span>
0011 <span class="comment">%   dim_i = TFDimension('name', 'i', 'cardinality', 5);</span>
0012 <span class="comment">%   dim_j = TFDimension('cardinality', 6, 'name', 'j');</span>
0013 <span class="comment">%   dim_k = TFDimension('cardinality', 7, 'name', 'k');</span>
0014 <span class="comment">%   dim_r = TFDimension('cardinality', 10, 'name', 'r');</span>
0015 <span class="comment">%</span>
0016 <span class="comment">%   p_A=TFFactor('name', 'p_A', 'type', 'latent', 'dims', [dim_i dim_r]);</span>
0017 <span class="comment">%   p_B=TFFactor('name', 'p_B', 'type', 'latent', 'dims', [dim_j dim_r]);</span>
0018 <span class="comment">%   p_C=TFFactor('name', 'p_C', 'type', 'latent', 'dims', [dim_k dim_r]);</span>
0019 <span class="comment">%</span>
0020 <span class="comment">%   parafac_model = TFModel('name', 'Parafac', 'factors', [p_A p_B p_C X], 'dims', [dim_i dim_j dim_k dim_r]);</span>
0021 <span class="comment">%</span>
0022 <span class="comment">%   parafac_model.rand_init_latent_factors('all');</span>
0023 <span class="comment">%</span>
0024 <span class="comment">%   See also TFDimension, TFFactor</span>
0025 
0026 classdef <a href="TFModel.html" class="code" title="">TFModel</a>
0027 
0028     properties
0029         name=<span class="string">''</span>;          <span class="comment">% name of the model</span>
0030         factors=<a href="TFFactor.html" class="code" title="">TFFactor</a>; <span class="comment">% array of TFFactor</span>
0031 
0032         dims=<a href="TFDimension.html" class="code" title="">TFDimension</a>; <span class="comment">% array of TFDimension used by factors defines</span>
0033                           <span class="comment">% order of dimensions on memory</span>
0034 
0035         cost=0;
0036 
0037     <span class="keyword">end</span>
0038 
0039     methods
0040 
0041         <a name="_sub0" href="#_subfunctions" class="code">function obj = TFModel(varargin)</a>
0042             p = inputParser;
0043             addParamValue(p, <span class="string">'name'</span>, <span class="string">''</span>, @isstr);
0044             addParamValue(p, <span class="string">'factors'</span>, [], @isvector);
0045             addParamValue(p, <span class="string">'dims'</span>, [], @isvector);
0046 
0047             parse(p,varargin{:});
0048 
0049             <span class="comment">% check if all dims elements are TFDimension objects</span>
0050             <span class="keyword">for</span> i = 1:length(p.Results.dims)
0051                 <span class="keyword">if</span> ~isa(p.Results.dims(i), <span class="string">'TFDimension'</span>)
0052                     err = MException( <span class="keyword">...</span>
0053                         [<span class="string">'TFModel:DimensionNotTFDimension'</span>], <span class="keyword">...</span>
0054                         [<span class="string">'Dimensions of TFModel must be '</span> <span class="keyword">...</span>
0055                          <span class="string">'TFDimension objects'</span>]);
0056                     throw(err);
0057                 <span class="keyword">end</span>
0058             <span class="keyword">end</span>
0059             obj.dims = p.Results.dims;
0060 
0061             <span class="comment">% check if all factors are TFFactor objects</span>
0062             <span class="keyword">for</span> i = 1:length(p.Results.factors)
0063                 <span class="keyword">if</span> ~isa(p.Results.factors(i), <span class="string">'TFFactor'</span>)
0064                     err = MException( <span class="keyword">...</span>
0065                         [<span class="string">'TFModel:FactorsNotTFFactor'</span>], <span class="keyword">...</span>
0066                         [<span class="string">'Factors of TFModel must be '</span> <span class="keyword">...</span>
0067                          <span class="string">'TFFactor objects'</span>]);
0068                     throw(err);
0069                 <span class="keyword">end</span>
0070             <span class="keyword">end</span>
0071             obj.factors = p.Results.factors;
0072 
0073             obj.name = p.Results.name;
0074 
0075         <span class="keyword">end</span>
0076 
0077         <a name="_sub1" href="#_subfunctions" class="code">function [] = pltf(obj, iternum)</a>
0078         <span class="comment">% performs PLTF update operations on the model</span>
0079         <span class="comment">% returns estimated TFFactor (\hat(X))</span>
0080         <span class="comment">% iternum: number of iterations</span>
0081         <span class="comment">% defines order of contraction operations</span>
0082 
0083             hat_X = obj.observed_factor;
0084             hat_X.name = <span class="string">'hat_X'</span>;
0085 
0086             eval( [ <span class="string">'global '</span> obj.observed_factor.get_data_name() <span class="keyword">...</span>
0087                     <span class="string">';'</span> ] );
0088             <span class="keyword">global</span> hat_X_data;
0089             hat_X.rand_init(obj.dims, 100);
0090 
0091             mask = obj.observed_factor;
0092             mask.name = <span class="string">'mask'</span>;
0093             <span class="keyword">global</span> mask_data;
0094             mask_data = ones(size(hat_X_data));
0095 
0096             KL=zeros(1,iternum);
0097             <span class="keyword">for</span> iter = 1:iternum
0098                 <span class="keyword">for</span> alpha=1:length(obj.latent_factor_indices)
0099                     <span class="comment">% access global data</span>
0100                     X_name = <span class="keyword">...</span>
0101                         obj.factors(obj.observed_factor_index) <span class="keyword">...</span>
0102                         .get_data_name();
0103                     eval([<span class="string">'global '</span> X_name <span class="string">';'</span>]);
0104                     Z_alpha_name = <span class="keyword">...</span>
0105                         obj.factors(alpha).get_data_name();
0106                     eval( [ <span class="string">'global '</span> Z_alpha_name <span class="string">';'</span> ] );
0107 
0108 
0109 
0110 
0111                     <span class="comment">% recalculate hat_X</span>
0112                     newmodel = obj;
0113 
0114                     <span class="keyword">if</span> iter==1 &amp;&amp; alpha==1
0115                         <span class="comment">%g = newmodel.schedule_dp();</span>
0116                         <span class="comment">%system([ 'rm /tmp/img.eps; echo '' ' g.print_dot  [' '' |' ...</span>
0117                         <span class="comment">%                    ' dot -o /tmp/img.eps; ' ...</span>
0118                         <span class="comment">%                    ' display  /tmp/img.eps ' ...</span>
0119                         <span class="comment">%                    ' ' ] ] );</span>
0120                     <span class="keyword">end</span>
0121 
0122                     <span class="comment">% perform contraction</span>
0123                     newmodel = newmodel.contract_all();
0124 
0125                     <span class="comment">% store result in hat_X_data</span>
0126                     result_name = <span class="keyword">...</span>
0127                         newmodel.get_first_non_observed_factor() <span class="keyword">...</span>
0128                         .get_data_name();
0129                     eval([<span class="string">'global '</span> result_name <span class="string">';'</span>] );
0130                     eval([<span class="string">'hat_X_data = '</span> result_name <span class="string">';'</span> ] ); 
0131 
0132 
0133 
0134                     <span class="comment">% store X / hat_X in hat_X data</span>
0135                     eval( [ <span class="string">'hat_X_data  =  '</span> <span class="keyword">...</span>
0136                             X_name <span class="keyword">...</span>
0137                             <span class="string">' ./ '</span> <span class="keyword">...</span>
0138                             <span class="string">' hat_X_data ;'</span> ] );
0139 
0140 
0141                     <span class="comment">% generate D1</span>
0142                     obj.delta(alpha, <span class="string">'D1_data'</span>, hat_X);
0143 
0144                     <span class="comment">% generate D2</span>
0145                     obj.delta(alpha, <span class="string">'D2_data'</span>, mask);
0146 
0147                     <span class="comment">% update Z_alpha</span>
0148                     <span class="keyword">global</span> D1_data D2_data;
0149                     eval( [ Z_alpha_name <span class="string">'='</span> Z_alpha_name <span class="string">' .* '</span> <span class="keyword">...</span>
0150                             <span class="string">'D1_data'</span>                     <span class="string">' ./ '</span> <span class="keyword">...</span>
0151                             <span class="string">'D2_data ;'</span> ] );
0152 
0153 
0154                     <span class="comment">% calculate KL divergence</span>
0155                     eval ( [ <span class="string">'KL(iter) = sum(sum(sum( (hat_X_data .* '</span> X_name <span class="string">') .* '</span> <span class="keyword">...</span>
0156                              <span class="string">' (log( (hat_X_data .* '</span> X_name <span class="string">') ) - '</span> <span class="keyword">...</span>
0157                              <span class="string">'log('</span> X_name <span class="keyword">...</span>
0158                              <span class="string">') ) - (hat_X_data .* '</span> X_name <span class="string">')'</span> <span class="keyword">...</span>
0159                              <span class="string">'+ '</span> X_name <span class="keyword">...</span>
0160                              <span class="string">')));'</span> ]);
0161 
0162                 <span class="keyword">end</span>
0163             <span class="keyword">end</span>
0164             display([<span class="string">'KL divergence over iterations: '</span>]);
0165             display(KL);
0166             plot(KL);
0167             title(<span class="string">'KL divergence over iterations'</span>);
0168             xlabel(<span class="string">'iteration number'</span>);
0169             ylabel(<span class="string">'KL divergence'</span>);
0170         <span class="keyword">end</span>
0171 
0172         <a name="_sub2" href="#_subfunctions" class="code">function [] = delta(obj, alpha, output_name, A)</a>
0173         <span class="comment">% PLTF delta function implementation</span>
0174         <span class="comment">% alpha: index of latent factor in TFModel.factors array</span>
0175         <span class="comment">% which will be updated</span>
0176         <span class="comment">% name: unique name used as the name of calculated delta</span>
0177         <span class="comment">% factor data</span>
0178         <span class="comment">% A: operand element of delta function assumed all ones if</span>
0179         <span class="comment">% not given</span>
0180             
0181             <span class="comment">% create new model for delta operation</span>
0182             d_model = obj;
0183 
0184             <span class="comment">% remove observed factor</span>
0185             d_model.factors(d_model.observed_factor_index) = [];
0186 
0187             <span class="comment">% add Z_alpha as new observed factor</span>
0188             d_model.factors(alpha).isLatent = 0;
0189             d_model.factors(alpha).isObserved= 1;
0190 
0191             <span class="comment">% if given, add A as a new latent factor</span>
0192             <span class="keyword">if</span> nargin == 4
0193                 A.isLatent = 1;
0194                 A.isObserved = 0;
0195                 d_model.factors = [d_model.factors A];
0196             <span class="keyword">end</span>
0197 
0198 
0199             <span class="comment">%g = d_model.schedule_dp();</span>
0200             <span class="comment">%system( [ 'rm /tmp/img.eps; echo '' ' g.print_dot  [' '' |' ...</span>
0201             <span class="comment">%                    ' dot -o /tmp/img.eps ;  display  /tmp/img.eps; ' ] ] );</span>
0202             <span class="comment">% perform contraction</span>
0203             d_model=d_model.contract_all();
0204 
0205             eval( [ <span class="string">'global '</span> output_name <span class="string">';'</span>] );
0206             eval( [ <span class="string">'global '</span> <span class="keyword">...</span>
0207                     d_model.get_first_non_observed_factor().get_data_name() <span class="string">';'</span><span class="keyword">...</span>
0208                   ] );
0209 
0210             eval( [ output_name <span class="string">'='</span> <span class="keyword">...</span>
0211                     d_model.get_first_non_observed_factor().get_data_name() <span class="keyword">...</span>
0212                     <span class="string">';'</span> ]);
0213         <span class="keyword">end</span>
0214 
0215         <a name="_sub3" href="#_subfunctions" class="code">function [r] = eq(a,b)</a>
0216             r = false;
0217 
0218             <span class="comment">% mark matched b factors</span>
0219             <span class="comment">% if there are any unmarked -&gt; inequal</span>
0220             <span class="comment">% problematic case:</span>
0221             <span class="comment">% a.factors ( ip, jpi ) , b.factors (  ip, pi )</span>
0222             <span class="comment">% b==a matches all b objects with a.factors(1)</span>
0223             <span class="comment">% but a~=b !</span>
0224 
0225             b_marks = zeros(size(b.factors));
0226 
0227             <span class="keyword">if</span> length(a.factors) == length(b.factors)
0228                 <span class="keyword">for</span> f_a = 1:length(a.factors)
0229                     found = 0;
0230                     <span class="keyword">for</span> f_b = 1:length(b.factors)
0231                         <span class="keyword">if</span> a.factors(f_a) == b.factors(f_b) &amp;&amp; <span class="keyword">...</span>
0232                                 b_marks(f_b) == 0
0233                             found = 1;
0234                             b_marks(f_b) = 1;
0235                             <span class="keyword">break</span>
0236                         <span class="keyword">end</span>
0237                     <span class="keyword">end</span>
0238 
0239                     <span class="keyword">if</span> found == 0
0240                         <span class="keyword">return</span>
0241                     <span class="keyword">end</span>
0242                 <span class="keyword">end</span>
0243 
0244                 r = true;
0245             <span class="keyword">end</span>
0246         <span class="keyword">end</span>
0247 
0248         <a name="_sub4" href="#_subfunctions" class="code">function [uncontraction_dims] = get_uncontraction_dims(obj)</a>
0249         <span class="comment">% returns list of TFDimension objects representing</span>
0250         <span class="comment">% dimensions which are required to be added to the current</span>
0251         <span class="comment">% TFModel object in order to reach initial model where</span>
0252         <span class="comment">% uncontraction_dims = {}</span>
0253         <span class="comment">% Calculation is performed as follows:</span>
0254         <span class="comment">% uncontraction_dims = contraction_dims - current_contraction_dims</span>
0255 
0256             contraction_dims = obj.get_contraction_dims();
0257             current_contraction_dims = <span class="keyword">...</span>
0258                 obj.get_current_contraction_dims();
0259             uncontraction_dims = [];
0260 
0261             <span class="keyword">for</span> cdi = 1:length(contraction_dims)
0262                 found=0;
0263                 <span class="keyword">for</span> ccdi = 1:length(current_contraction_dims)
0264                     <span class="keyword">if</span> contraction_dims(cdi) == <span class="keyword">...</span>
0265                             char(current_contraction_dims(ccdi))
0266                         found=1;
0267                         <span class="keyword">break</span>;
0268                     <span class="keyword">end</span>
0269                 <span class="keyword">end</span>
0270                 <span class="keyword">if</span> ~found
0271                     uncontraction_dims = [ uncontraction_dims <span class="keyword">...</span>
0272                                         contraction_dims(cdi) ];
0273                 <span class="keyword">end</span>
0274             <span class="keyword">end</span>
0275         <span class="keyword">end</span>
0276 
0277 
0278         <a name="_sub5" href="#_subfunctions" class="code">function [graph] = schedule_dp(obj)</a>
0279         <span class="comment">% returns a tree of TFModel generated as a result of the</span>
0280         <span class="comment">% search for least memory consuming contraction sequence</span>
0281         <span class="comment">% with a dynamic programming approach</span>
0282 
0283             output_dims = obj.get_contraction_dims();
0284             contraction_dims = obj.get_contraction_dims();
0285             
0286             <span class="comment">% generate final state of contraction operation to be</span>
0287             <span class="comment">% used as the initial state of dp search</span>
0288             end_node = obj.contract_all();
0289 
0290             graph = <a href="TFGraph.html" class="code" title="">TFGraph</a>;
0291             process_nodes = [end_node];
0292             processing_node = 1;
0293 
0294             <span class="keyword">while</span> length(process_nodes) &gt;= processing_node
0295                 cur_node = process_nodes(processing_node);
0296                 cur_node = cur_node.update_cost_from_latent();
0297 
0298                 <span class="comment">% init graph.node_list</span>
0299                 <span class="keyword">if</span> length(graph.node_list) == 0
0300                     graph.node_list = [cur_node];
0301                     graph=graph.clear_edges();
0302                 <span class="keyword">end</span>
0303 
0304                 uncontraction_dims = cur_node.get_uncontraction_dims();
0305                 <span class="keyword">for</span> udi = 1:length(uncontraction_dims)
0306                     new_node = cur_node.uncontract(obj, <span class="keyword">...</span>
0307                                                    uncontraction_dims(udi));
0308                     new_node = new_node.update_cost_from_latent();
0309 
0310                     <span class="comment">% memoization</span>
0311                     nnidx = graph.exists(new_node);
0312                     <span class="keyword">if</span> nnidx
0313                         graph = graph.update_node(cur_node, new_node, nnidx);
0314                     <span class="keyword">else</span>
0315                         graph = graph.append_node(cur_node, new_node);
0316                         process_nodes = [ process_nodes new_node ];
0317                     <span class="keyword">end</span>
0318                 <span class="keyword">end</span>
0319 
0320                 processing_node = processing_node + 1;
0321 
0322             <span class="keyword">end</span>
0323 
0324         <span class="keyword">end</span>
0325 
0326 
0327         <a name="_sub6" href="#_subfunctions" class="code">function [newmodel] = uncontract(obj, orig_model, dim)</a>
0328         <span class="comment">% returns a new TFModel generated by adding given</span>
0329         <span class="comment">% TFDimension object dim to the model.</span>
0330         <span class="comment">% dim: TFDimension object to uncontract</span>
0331         <span class="comment">% orig_model: provides original non-contracted model data</span>
0332 
0333             newmodel = obj;
0334 
0335             newmodel.name = [ newmodel.name  <span class="keyword">...</span>
0336                               <span class="string">'_uncontract_'</span> dim.name ];
0337 
0338             uncontract_dims = obj.get_uncontraction_dims();
0339             other_dims = []; <span class="comment">% already contracted dimensions</span>
0340             <span class="keyword">for</span> i=1:length(uncontract_dims)
0341                 <span class="keyword">if</span> uncontract_dims(i) ~= dim
0342                     other_dims = [ other_dims <span class="keyword">...</span>
0343                                    uncontract_dims(i) ];
0344                 <span class="keyword">end</span>
0345             <span class="keyword">end</span>
0346 
0347             <span class="comment">% reset newmodel's factors</span>
0348             newmodel.factors = [];
0349 
0350             <span class="comment">% stores factors which will contribute to the temporary</span>
0351             <span class="comment">% factor</span>
0352             tmp_factor_parents = [];
0353 
0354 
0355             <span class="comment">% populate newmode.factors with factors independant</span>
0356             <span class="comment">% from uncontraction operation</span>
0357             <span class="keyword">for</span> fi = 1:length(orig_model.factors)
0358                 found = 0;
0359                 <span class="keyword">for</span> fdi = 1:length(orig_model.factors(fi).dims)
0360                     <span class="keyword">for</span> odi = 1:length(other_dims)
0361                         <span class="comment">% if any factor contains any one of the</span>
0362                         <span class="comment">% other_dims can not use it as it is, must</span>
0363                         <span class="comment">% create a temporary factor for those</span>
0364                         <span class="comment">% here we identify factors we will use</span>
0365                         <span class="comment">% without modification</span>
0366 
0367                         <span class="keyword">if</span> other_dims(odi) == <span class="keyword">...</span>
0368                                 orig_model.factors(fi).dims(fdi)
0369                             found=1;
0370                             <span class="keyword">break</span>
0371                         <span class="keyword">end</span>
0372                     <span class="keyword">end</span>
0373                     <span class="keyword">if</span> found, <span class="keyword">break</span>; <span class="keyword">end</span>
0374                 <span class="keyword">end</span>
0375 
0376                 <span class="keyword">if</span> ~found
0377                     <span class="comment">% if other_dims are not found in this factor then</span>
0378                     <span class="comment">% use this factor as it is in the new node</span>
0379 
0380                     newmodel.factors = [newmodel.factors <span class="keyword">...</span>
0381                                         orig_model.factors(fi) ];
0382                 <span class="keyword">else</span>
0383                     <span class="comment">% in other case this factor will be inspected</span>
0384                     <span class="comment">% further to generate temporary factor</span>
0385                     tmp_factor_parents = [ tmp_factor_parents <span class="keyword">...</span>
0386                                         orig_model.factors(fi) ];
0387                 <span class="keyword">end</span>
0388             <span class="keyword">end</span>
0389 
0390             <span class="comment">% make sure factors are unique</span>
0391             <span class="comment">%newmodel.factors = unique(newmodel.factors);</span>
0392 
0393             <span class="comment">% inspect tmp_factor_parents and generate a temporary</span>
0394             <span class="comment">% model</span>
0395             tmpf = <a href="TFFactor.html" class="code" title="">TFFactor</a>;
0396             tmpf.isTemp = 1;
0397             tmpf.name = <span class="string">'tmp'</span>;
0398             names={};
0399             tmpf.dims = [];
0400 
0401             <span class="comment">% add all dimensions of all parent factors</span>
0402             <span class="keyword">for</span> tfpi = 1:length(tmp_factor_parents)
0403                 <span class="keyword">for</span> di = 1:length(tmp_factor_parents(tfpi).dims)
0404                     <span class="keyword">if</span> tmp_factor_parents(tfpi).isLatent
0405                         <span class="comment">% if dimension is not one of the other_dims</span>
0406                         <span class="comment">% then add it to the temporary factor</span>
0407                         found = 0;
0408                         <span class="keyword">for</span> odi = 1:length(other_dims)
0409                             <span class="keyword">if</span> other_dims(odi) == <span class="keyword">...</span>
0410                                     tmp_factor_parents(tfpi).dims(di)
0411                                 found = 1;
0412                                 <span class="keyword">break</span>;
0413                             <span class="keyword">end</span>
0414                         <span class="keyword">end</span>
0415 
0416 
0417                         <span class="keyword">if</span> ~found
0418                             <span class="comment">% if not already added</span>
0419                             found2 = 0;
0420                             <span class="keyword">for</span> tmpfdind = 1:length(tmpf.dims)
0421                                 <span class="keyword">if</span> tmpf.dims(tmpfdind) == <span class="keyword">...</span>
0422                                         tmp_factor_parents(tfpi).dims(di)
0423                                     found2 = 1;
0424                                     <span class="keyword">break</span>;
0425                                 <span class="keyword">end</span>
0426                             <span class="keyword">end</span>
0427 
0428                             <span class="keyword">if</span> ~found2
0429 
0430                                 tmpf.dims = [ tmpf.dims <span class="keyword">...</span>
0431                                               tmp_factor_parents(tfpi) <span class="keyword">...</span>
0432                                               .dims(di)];
0433                                 names = [ names <span class="keyword">...</span>
0434                                           tmp_factor_parents(tfpi) <span class="keyword">...</span>
0435                                           .dims(di).name];
0436                             <span class="keyword">end</span>
0437                         <span class="keyword">end</span>
0438                     <span class="keyword">end</span>
0439                 <span class="keyword">end</span>
0440             <span class="keyword">end</span>
0441 
0442             <span class="comment">% if no names are found then there is no temporary</span>
0443             <span class="comment">% factor added</span>
0444             <span class="keyword">if</span> length(names)
0445                 <span class="comment">% make sure tmp.factor dims are unique</span>
0446                 <span class="comment">%'Ã¶nce'</span>
0447                 <span class="comment">%tmpf.dims.name</span>
0448                 <span class="comment">%tmpf.dims = unique(tmpf.dims);</span>
0449                 <span class="comment">%'sonra'</span>
0450                 <span class="comment">%tmpf.dims.name</span>
0451                 
0452                 names=obj.order_dims(unique(names));
0453                 <span class="keyword">for</span> d = 1:length(names)
0454                     tmpf.name = [ tmpf.name <span class="string">'_'</span> char(names(d)) ];
0455                 <span class="keyword">end</span>
0456                 <span class="comment">%tmpf.name = [tmpf.name '_minus_' ? ];</span>
0457                 
0458                 newmodel.factors = [ newmodel.factors tmpf ];
0459 
0460                 newmodel = newmodel.update_cost_from_latent();
0461             <span class="keyword">end</span>
0462 
0463         <span class="keyword">end</span>
0464 
0465         <a name="_sub7" href="#_subfunctions" class="code">function [newmodel] = contract(obj, dim)</a>
0466         <span class="comment">% returns a new TFModel generated by contracting obj with</span>
0467         <span class="comment">% dim which may add new temporary factors.</span>
0468         <span class="comment">% dim: TFDimension or char array or cell with the name of</span>
0469         <span class="comment">% the dimension</span>
0470 
0471             <span class="keyword">if</span> isa(dim, <span class="string">'TFDimension'</span>)
0472                 dim = dim.name;
0473             <span class="keyword">elseif</span> isa(dim, <span class="string">'char'</span>) || isa(dim, <span class="string">'cell'</span>)
0474                 dim = char(dim);
0475             <span class="keyword">else</span>
0476                 display([<span class="string">'ERROR: unsupported dim type '</span> class(dim) <span class="keyword">...</span>
0477                          <span class="string">'was expecting TFDimension, cell or char '</span> <span class="keyword">...</span>
0478                          <span class="string">'array'</span>]);
0479                 <span class="keyword">return</span>
0480             <span class="keyword">end</span>
0481 
0482             newmodel = obj;
0483             newmodel.name = [obj.name <span class="string">'_'</span> dim];
0484 
0485             <span class="comment">% remove dim from the new model's factors'</span>
0486             contracted_factor_inds = [];
0487             <span class="keyword">for</span> f = 1:length(newmodel.factors)
0488                 <span class="keyword">if</span> ~newmodel.factors(f).isObserved
0489                     ind = <span class="keyword">...</span>
0490                         newmodel.factors(f).got_dimension(char(dim));
0491                     
0492                     <span class="keyword">if</span> ind ~= 0
0493                         <span class="comment">% remove this dimension from this factor</span>
0494                         newmodel.factors(f).dims(ind) = [];
0495 
0496                         contracted_factor_inds = <span class="keyword">...</span>
0497                             [ contracted_factor_inds f ];
0498                     <span class="keyword">end</span>
0499                 <span class="keyword">end</span>
0500             <span class="keyword">end</span>
0501 
0502             <span class="comment">% add a temporary factor including dimensions of</span>
0503             <span class="comment">% contracted factors other than contracted dimension</span>
0504             tmp=<a href="TFFactor.html" class="code" title="">TFFactor</a>;
0505             tmp.isTemp = 1;
0506             tmp.name = <span class="string">'tmp'</span>;
0507             names={};
0508             
0509             <span class="keyword">for</span> cfii = 1:length(contracted_factor_inds)
0510                 <span class="comment">% for each dimension of the contracted factor</span>
0511                 <span class="keyword">for</span> cfi_dim = 1:length(newmodel.factors(contracted_factor_inds(cfii)).dims)
0512                     found=0;
0513                     <span class="keyword">for</span> ti = 1:length(tmp.dims)
0514                         <span class="keyword">if</span> tmp.dims(ti) == <span class="keyword">...</span>
0515                                 newmodel.factors(contracted_factor_inds(cfii)).dims(cfi_dim)
0516                             found=1;
0517                             <span class="keyword">break</span>;
0518                         <span class="keyword">end</span>
0519                     <span class="keyword">end</span>
0520                     <span class="keyword">if</span> found == 0
0521                         tmp.dims = [tmp.dims <span class="keyword">...</span>
0522                                     newmodel.factors(contracted_factor_inds(cfii)) <span class="keyword">...</span>
0523                                     .dims(cfi_dim)];
0524                         names=[names <span class="keyword">...</span>
0525                               newmodel.factors(contracted_factor_inds(cfii)).dims(cfi_dim).name];
0526                         <span class="comment">%display(['added from factor index' ...</span>
0527                         <span class="comment">%         contracted_factor_inds(cfii)])</span>
0528                         <span class="comment">%display(['added from factor' newmodel.factors(contracted_factor_inds(cfii)).name])</span>
0529                         <span class="comment">%display(['addd dim' char(newmodel.factors(contracted_factor_inds(cfii)).dims(cfi_dim).name)])</span>
0530                     <span class="keyword">end</span>
0531                 <span class="keyword">end</span>
0532             <span class="keyword">end</span>
0533             names=unique(names);
0534             <span class="keyword">for</span> d = 1:length(names)
0535                 tmp.name = [tmp.name <span class="string">'_'</span> char(names(d))];
0536             <span class="keyword">end</span>
0537             tmp.name = [tmp.name <span class="string">'_minus_'</span> dim];
0538 
0539 
0540 
0541 
0542             eval( [ <span class="string">'global '</span> tmp.get_data_name()  <span class="string">';'</span>] );
0543 
0544             <span class="keyword">if</span> length(contracted_factor_inds) == 1
0545                 <span class="comment">% no multiplication</span>
0546                 eval( [ <span class="string">'global '</span> <span class="keyword">...</span>
0547                         obj.factors(contracted_factor_inds(1)) <span class="keyword">...</span>
0548                         .get_data_name() <span class="string">';'</span>] );
0549                 eval( [ tmp.get_data_name() <span class="string">' = '</span> <span class="keyword">...</span>
0550                         obj.factors(contracted_factor_inds(1)) <span class="keyword">...</span>
0551                         .get_data_name() <span class="string">';'</span>] );
0552             <span class="keyword">else</span>
0553 
0554                 <span class="comment">% multiply first two into tmp data</span>
0555                 eval( [ <span class="string">'global'</span> <span class="keyword">...</span>
0556                         <span class="string">' '</span> obj.factors(contracted_factor_inds(1)).get_data_name() <span class="keyword">...</span>
0557                         <span class="string">' '</span> obj.factors(contracted_factor_inds(2)).get_data_name() <span class="string">';'</span>] );
0558 
0559                 eval( [ tmp.get_data_name() <span class="string">' = bsxfun (@times, '</span> <span class="keyword">...</span>
0560                         obj.factors(contracted_factor_inds(1)).get_data_name() <span class="string">', '</span><span class="keyword">...</span>
0561                         obj.factors(contracted_factor_inds(2)).get_data_name() <span class="string">');'</span> <span class="keyword">...</span>
0562                       ] );
0563 
0564                 <span class="comment">% multiply tmp data with other factors</span>
0565                 <span class="keyword">for</span> cfii = 3:length(contracted_factor_inds)
0566                     eval( [ <span class="string">'global '</span><span class="keyword">...</span>
0567                             obj.factors(contracted_factor_inds(cfii)) <span class="keyword">...</span>
0568                             .get_data_name() <span class="string">';'</span>] );
0569                     eval( [ tmp.get_data_name() <span class="string">' = bsxfun (@times, '</span> <span class="keyword">...</span>
0570                             tmp.get_data_name() <span class="string">','</span><span class="keyword">...</span>
0571                             obj.factors(contracted_factor_inds(cfii)) <span class="keyword">...</span>
0572                             .get_data_name() <span class="string">');'</span> ] );
0573                 <span class="keyword">end</span>
0574             <span class="keyword">end</span>
0575 
0576 
0577             <span class="comment">% sum contraction dimensions on tmp data</span>
0578             
0579             con_dim_index = obj.get_dimension_index(dim);
0580 
0581             eval( [ tmp.get_data_name() <span class="string">' = sum( '</span> <span class="keyword">...</span>
0582                     tmp.get_data_name() <span class="string">', '</span> <span class="keyword">...</span>
0583                     num2str(con_dim_index) <span class="string">');'</span>] );
0584             
0585             newmodel.factors = [newmodel.factors tmp];
0586 
0587 
0588             <span class="comment">% remove contracted factors</span>
0589             <span class="comment">% other dimensions live within the tmp factor</span>
0590             removed_num=0; <span class="comment">% removal breaks loop index</span>
0591             <span class="keyword">for</span> cfii = 1:length(contracted_factor_inds)
0592                 newmodel.factors(contracted_factor_inds(cfii) <span class="keyword">...</span>
0593                                  - removed_num) = [];
0594                 removed_num = removed_num + 1;
0595             <span class="keyword">end</span>
0596         <span class="keyword">end</span>
0597 
0598 
0599         <a name="_sub8" href="#_subfunctions" class="code">function [obj] = update_cost_from_latent(obj)</a>
0600             obj.cost = 0;
0601             lfi=obj.latent_factor_indices();
0602             <span class="keyword">for</span> fi = 1:length(lfi)
0603                 obj.cost = obj.cost + <span class="keyword">...</span>
0604                     obj.factors(lfi(fi)).get_element_size();
0605             <span class="keyword">end</span>
0606         <span class="keyword">end</span>
0607 
0608 
0609         <a name="_sub9" href="#_subfunctions" class="code">function [dn fn all_edges] = print_ubigraph(obj)</a>
0610         <span class="comment">% returns a string to be used by fgplot</span>
0611 
0612         <span class="comment">% add dimension nodes</span>
0613             dn = [ <span class="string">'[ '''</span> ];
0614             <span class="keyword">for</span> i =1:length(obj.dims)
0615                 <span class="keyword">if</span> i ~= 1
0616                     dn = [ dn <span class="string">''','''</span> ];
0617                 <span class="keyword">end</span>
0618                 dn = [ dn obj.dims(i).name ];
0619             <span class="keyword">end</span>
0620             dn = [ dn <span class="string">''' ] '</span> ];
0621 
0622             <span class="comment">% add factor nodes</span>
0623             fn = [ <span class="string">'[ '''</span> ];
0624             <span class="keyword">for</span> i =1:length(obj.factors)
0625                 <span class="keyword">if</span> i ~= 1
0626                     fn = [ fn <span class="string">''','''</span> ];
0627                 <span class="keyword">end</span>
0628                 fn = [ fn obj.factors(i).name ];
0629             <span class="keyword">end</span>
0630             fn = [ fn <span class="string">''' ] '</span> ];
0631 
0632             <span class="comment">% add edges</span>
0633             all_edges=[<span class="string">'[ '</span> ];
0634             <span class="keyword">for</span> d = 1:length(obj.dims)
0635                 <span class="keyword">if</span> d ~= 1
0636                     all_edges = [ all_edges <span class="string">' , '</span> ];
0637                 <span class="keyword">end</span>
0638 
0639                 edges=[<span class="string">'[ '</span> ];
0640 
0641                 <span class="comment">% include this dimension if a factor uses it</span>
0642                 <span class="keyword">for</span> f = 1:length(obj.factors)
0643                     <span class="keyword">for</span> fd = 1:length(obj.factors(f).dims)
0644                         <span class="keyword">if</span> obj.factors(f).dims(fd) == obj.dims(d)
0645                             <span class="keyword">if</span> length(edges) ~= 2
0646                                 edges = [ edges <span class="string">''','''</span> ];
0647                             <span class="keyword">else</span>
0648                                 edges = [ edges <span class="string">''''</span> ];
0649                             <span class="keyword">end</span>
0650                             edges = [ edges obj.factors(f).name ];
0651                         <span class="keyword">end</span>
0652                     <span class="keyword">end</span>
0653                 <span class="keyword">end</span>
0654 
0655                 all_edges = [ all_edges edges <span class="string">''' ]'</span> ];
0656             <span class="keyword">end</span>
0657             all_edges = [ all_edges <span class="string">' ]'</span> ];
0658         <span class="keyword">end</span>
0659 
0660         <a name="_sub10" href="#_subfunctions" class="code">function [size] = get_element_size(obj)</a>
0661         <span class="comment">% returns number of elements for this model</span>
0662             size=0;
0663             <span class="keyword">for</span> f = 1:length(obj.factors)
0664                 <span class="keyword">if</span> obj.factors(f).isObserved == 0
0665                     size = size + <span class="keyword">...</span>
0666                            obj.factors(f).get_element_size();
0667                 <span class="keyword">end</span>
0668             <span class="keyword">end</span>
0669         <span class="keyword">end</span>
0670 
0671         <a name="_sub11" href="#_subfunctions" class="code">function [card] = get_index_card(obj, index_char)</a>
0672         <span class="comment">% returns cardinality of a given name of a dimension</span>
0673             <span class="keyword">for</span> d = 1:length(obj.dims)
0674                 <span class="keyword">if</span> obj.dims(d).name == index_char
0675                     card = obj.dims(d).cardinality;
0676                     <span class="keyword">break</span>
0677                 <span class="keyword">end</span>
0678             <span class="keyword">end</span>
0679         <span class="keyword">end</span>
0680 
0681         <a name="_sub12" href="#_subfunctions" class="code">function [factor] = get_first_non_observed_factor(obj)</a>
0682         <span class="comment">% returns first non observed factor index, used to return</span>
0683         <span class="comment">% index of the output factor</span>
0684             <span class="keyword">for</span> f = 1:length(obj.factors)
0685                 <span class="keyword">if</span> obj.factors(f).isObserved == 0
0686                     factor = obj.factors(f);
0687                     <span class="keyword">return</span>
0688                 <span class="keyword">end</span>
0689             <span class="keyword">end</span>
0690         <span class="keyword">end</span>
0691 
0692         <a name="_sub13" href="#_subfunctions" class="code">function [ind] = get_first_non_observed_factor_index(obj)</a>
0693         <span class="comment">% returns first non observed factor index, used to return</span>
0694         <span class="comment">% index of the output factor</span>
0695             <span class="keyword">for</span> f = 1:length(obj.factors)
0696                 <span class="keyword">if</span> obj.factors(f).isObserved == 0
0697                     ind = f;
0698                     <span class="keyword">return</span>
0699                 <span class="keyword">end</span>
0700             <span class="keyword">end</span>
0701         <span class="keyword">end</span>
0702 
0703         <a name="_sub14" href="#_subfunctions" class="code">function [ind] = find_cell_char(obj, chars)</a>
0704         <span class="comment">% returns index of a given char array in object's dimension array</span>
0705             <span class="keyword">for</span> ind=1:length(obj.dims)
0706                 <span class="keyword">if</span> obj.dims(ind).name == chars
0707                     <span class="keyword">return</span>
0708                 <span class="keyword">end</span>
0709             <span class="keyword">end</span>
0710             ind=0;
0711         <span class="keyword">end</span>
0712 
0713        <a name="_sub15" href="#_subfunctions" class="code">function [r] = get_dimension_index(obj, dim)</a>
0714         <span class="comment">% returns index of dimension dim in obj.dims if obj</span>
0715         <span class="comment">% contains TFDimension (or char) dim returns 0 otherwise</span>
0716 
0717             r=0;
0718             <span class="keyword">for</span> d = 1:length(obj.dims)
0719                 <span class="keyword">if</span> obj.dims(d) == dim
0720                     r=d;
0721                     <span class="keyword">break</span>;
0722                 <span class="keyword">end</span>
0723             <span class="keyword">end</span>           
0724        <span class="keyword">end</span>
0725 
0726         <a name="_sub16" href="#_subfunctions" class="code">function [ordered_index_chars] = order_dims(obj, </a><span class="keyword">...</span>
0727                                                     dims_array)
0728             <span class="comment">% order given cell of dimension names according to</span>
0729             <span class="comment">% factor.dims order</span>
0730 
0731             tmp=cell(length(dims_array), 3);
0732 
0733             tmp(:,1) = dims_array;
0734             <span class="keyword">for</span> i = 1:length(dims_array)
0735                 tmp{i,2} = obj.get_index_card(char(dims_array(i)));
0736                 tmp{i,3} = obj.find_cell_char(char(dims_array(i))); <span class="comment">% order of the index</span>
0737                                                                     <span class="comment">% in the model</span>
0738             <span class="keyword">end</span>
0739 
0740             tmp=sortrows(tmp,3); <span class="comment">% sort by the order of the model indices</span>
0741             ordered_index_chars=tmp(:,1)';
0742         <span class="keyword">end</span>
0743 
0744 
0745         <a name="_sub17" href="#_subfunctions" class="code">function [newmodel] = contract_all(obj)</a>
0746             contract_dims = obj.get_contraction_dims();
0747 
0748             newmodel = obj;
0749             <span class="keyword">for</span> i = 1:length(contract_dims)
0750                 newmodel = newmodel.contract(contract_dims(i));
0751             <span class="keyword">end</span>
0752         <span class="keyword">end</span>
0753 
0754 
0755         <a name="_sub18" href="#_subfunctions" class="code">function [contract_dims] = get_contraction_dims(obj)</a>
0756         <span class="comment">% returns cell of dimensions which must be contracted to</span>
0757         <span class="comment">% calculate output factor(s)</span>
0758 
0759             output_chars = {};
0760             <span class="keyword">for</span> f=1:length(obj.factors)
0761                 <span class="keyword">if</span> obj.factors(f).isObserved
0762 
0763                     <span class="comment">% for each dimension of this factor</span>
0764                     <span class="keyword">for</span> i=1:length(obj.factors(f).dims)
0765                         output_chars = [output_chars <span class="keyword">...</span>
0766                                         obj.factors(f).dims(i).name];
0767                     <span class="keyword">end</span>
0768 
0769                 <span class="keyword">end</span>
0770             <span class="keyword">end</span>
0771 
0772             <span class="comment">% contraction dimensions: alldims - output_dims</span>
0773             contract_dims={};
0774             <span class="keyword">for</span> d_a = 1:length(obj.dims)
0775                 found=0;
0776                 <span class="keyword">for</span> d_o = 1:length(output_chars)
0777                     <span class="keyword">if</span> obj.dims(d_a) == char(output_chars(d_o))
0778                         found=1;
0779                         <span class="keyword">break</span>
0780                     <span class="keyword">end</span>
0781                 <span class="keyword">end</span>
0782 
0783                 <span class="keyword">if</span> found == 0
0784                     contract_dims = [contract_dims obj.dims(d_a)];
0785                     <span class="comment">%['add '  obj.dims(d_a).name]</span>
0786                 <span class="keyword">end</span>
0787             <span class="keyword">end</span>
0788 
0789             <span class="comment">%['return ' contract_dims.name]</span>
0790             <span class="comment">%contract_dims = obj.order_dims(unique(contract_dims));</span>
0791         <span class="keyword">end</span>
0792 
0793         <a name="_sub19" href="#_subfunctions" class="code">function [contract_dims] = get_current_contraction_dims(obj)</a>
0794         <span class="comment">% returns cell of dimensions which must be contracted to</span>
0795         <span class="comment">% calculate output factor(s) by using current factors to</span>
0796         <span class="comment">% calculate all dimension not model.dims. (model.dims is always</span>
0797         <span class="comment">% fixed to maximum possible dimension list.)</span>
0798 
0799             output_chars = {};
0800             <span class="keyword">for</span> f=1:length(obj.factors)
0801                 <span class="keyword">if</span> obj.factors(f).isObserved
0802 
0803                     <span class="comment">% for each dimension of this factor</span>
0804                     <span class="keyword">for</span> i=1:length(obj.factors(f).dims)
0805                         output_chars = [output_chars <span class="keyword">...</span>
0806                                         obj.factors(f).dims(i).name];
0807                     <span class="keyword">end</span>
0808 
0809                 <span class="keyword">end</span>
0810             <span class="keyword">end</span>
0811 
0812             <span class="comment">% contraction dimensions: alldims - output_dims</span>
0813             alldims={};
0814             <span class="keyword">for</span> f = 1:length(obj.factors)
0815                 <span class="keyword">for</span> d = 1:length(obj.factors(f).dims)
0816                     found = 0;
0817                     n=obj.factors(f).dims(d).name;
0818                     <span class="keyword">for</span> i=1:length(alldims)
0819                         <span class="keyword">if</span> char(alldims(i)) == n
0820                             found = 1;
0821                             <span class="keyword">break</span>
0822                         <span class="keyword">end</span>
0823                     <span class="keyword">end</span>
0824 
0825                     <span class="keyword">if</span> ~found
0826                         alldims = [alldims n];
0827                     <span class="keyword">end</span>
0828                 <span class="keyword">end</span>
0829             <span class="keyword">end</span>
0830 
0831             contract_dims={};
0832             <span class="keyword">for</span> d_a = 1:length(alldims)
0833                 found=0;
0834                 <span class="keyword">for</span> d_o = 1:length(output_chars)
0835                     <span class="keyword">if</span> char(alldims(d_a)) == char(output_chars(d_o))
0836                         found=1;
0837                         <span class="keyword">break</span>
0838                     <span class="keyword">end</span>
0839                 <span class="keyword">end</span>
0840 
0841                 <span class="keyword">if</span> found == 0
0842                     contract_dims = [contract_dims alldims(d_a)];
0843                     <span class="comment">%['add '  alldims(d_a).name]</span>
0844                 <span class="keyword">end</span>
0845             <span class="keyword">end</span>
0846 
0847             <span class="comment">%['return ' contract_dims.name]</span>
0848             <span class="comment">%contract_dims = obj.order_dims(unique(contract_dims));</span>
0849         <span class="keyword">end</span>
0850 
0851 
0852         <a name="_sub20" href="#_subfunctions" class="code">function [factor_inds] = latent_factor_indices(obj)</a>
0853             factor_inds=[];
0854             <span class="keyword">for</span> f=1:length(obj.factors)
0855                 <span class="keyword">if</span> obj.factors(f).isLatent
0856                     factor_inds = [ factor_inds f ];
0857                 <span class="keyword">end</span>
0858             <span class="keyword">end</span>
0859         <span class="keyword">end</span>
0860 
0861 
0862         <a name="_sub21" href="#_subfunctions" class="code">function [factors] = latent_factors(obj)</a>
0863             factors=[];
0864             <span class="keyword">for</span> f=1:length(obj.factors)
0865                 <span class="keyword">if</span> obj.factors(f).isLatent
0866                     factors = [ factors obj.factors(f) ];
0867                 <span class="keyword">end</span>
0868             <span class="keyword">end</span>
0869         <span class="keyword">end</span>
0870 
0871         <a name="_sub22" href="#_subfunctions" class="code">function [factor_ind] = observed_factor_index(obj)</a>
0872             factor_ind=0;
0873             <span class="keyword">for</span> f=1:length(obj.factors)
0874                 <span class="keyword">if</span> obj.factors(f).isObserved
0875                     factor_ind = f;
0876                     <span class="keyword">return</span>
0877                 <span class="keyword">end</span>
0878             <span class="keyword">end</span>
0879         <span class="keyword">end</span>
0880 
0881         <a name="_sub23" href="#_subfunctions" class="code">function [factor] = observed_factor(obj)</a>
0882         <span class="comment">% returns first observed factor (useful for PLTF operations)</span>
0883             <span class="keyword">for</span> f=1:length(obj.factors)
0884                 <span class="keyword">if</span> obj.factors(f).isObserved
0885                     factor = obj.factors(f);
0886                     <span class="keyword">return</span>
0887                 <span class="keyword">end</span>
0888             <span class="keyword">end</span>
0889         <span class="keyword">end</span>
0890 
0891         <a name="_sub24" href="#_subfunctions" class="code">function [factors] = observed_factors(obj)</a>
0892             factors=[];
0893             <span class="keyword">for</span> f=1:length(obj.factors)
0894                 <span class="keyword">if</span> obj.factors(f).isObserved
0895                     factors = [ factors obj.factors(f) ];
0896                 <span class="keyword">end</span>
0897             <span class="keyword">end</span>
0898         <span class="keyword">end</span>
0899 
0900         <a name="_sub25" href="#_subfunctions" class="code">function [factors] = input_factors(obj)</a>
0901             factors=[];
0902             <span class="keyword">for</span> f=1:length(obj.factors)
0903                 <span class="keyword">if</span> obj.factors(f).isInput
0904                     factors = [ factors obj.factors(f) ];
0905                 <span class="keyword">end</span>
0906             <span class="keyword">end</span>
0907         <span class="keyword">end</span>
0908 
0909         <a name="_sub26" href="#_subfunctions" class="code">function [factors] = temp_factors(obj)</a>
0910             factors=[];
0911             <span class="keyword">for</span> f=1:length(obj.factors)
0912                 <span class="keyword">if</span> obj.factors(f).isTemp
0913                     factors = [ factors obj.factors(f) ];
0914                 <span class="keyword">end</span>
0915             <span class="keyword">end</span>
0916         <span class="keyword">end</span>
0917 
0918         <a name="_sub27" href="#_subfunctions" class="code">function [] = rand_init_latent_factors(obj, type, imax)</a>
0919 
0920             <span class="keyword">if</span> ~strcmp(type, <span class="string">'all'</span>) &amp;&amp; ~strcmp(type, <span class="string">'nonClamped'</span>)
0921                 throw(MException(<span class="string">'TFModel:WrongInitType'</span>, <span class="keyword">...</span>
0922                                  [<span class="string">'Supported init type values: all, '</span> <span class="keyword">...</span>
0923                                   <span class="string">'nonClamped'</span>]));
0924             <span class="keyword">end</span>
0925 
0926             <span class="keyword">for</span> fi=1:length(obj.latent_factor_indices)
0927 
0928                 <span class="keyword">if</span> strcmp(type, <span class="string">'all'</span>) || <span class="keyword">...</span>
0929                         ( strcmp(type, <span class="string">'nonClamped'</span>) &amp;&amp; <span class="keyword">...</span>
0930                           obj.factors(fi).isInput == 0 )
0931                     
0932                     <span class="keyword">if</span> nargin==2
0933                         obj.factors(fi).rand_init(obj.dims);
0934                     <span class="keyword">else</span>
0935                         obj.factors(fi).rand_init(obj.dims, imax);
0936                     <span class="keyword">end</span>
0937 
0938                 <span class="keyword">end</span>
0939             <span class="keyword">end</span>
0940 
0941         <span class="keyword">end</span>
0942 
0943     <span class="keyword">end</span>
0944 
0945 <span class="keyword">end</span></pre></div>
<hr><address>Generated on Tue 14-Aug-2012 15:00:33 by <strong><a href="http://www.artefact.tk/software/matlab/m2html/" target="_parent">m2html</a></strong> &copy; 2005</address>
</body>
</html>